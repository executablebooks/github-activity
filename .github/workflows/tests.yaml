name: continuous-integration

on:
  pull_request:
  push:
  workflow_dispatch:

jobs:
  pre-commit:
    runs-on: ubuntu-24.04
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.13

      # ref: https://github.com/pre-commit/action
      - uses: pre-commit/action@v3.0.1
      - name: Help message if pre-commit fail
        if: ${{ failure() }}
        run: |
          echo "You can install pre-commit hooks to automatically run formatting"
          echo "on each commit with:"
          echo "    pre-commit install"
          echo "or you can run by hand on staged files with"
          echo "    pre-commit run"
          echo "or after-the-fact on already committed files with"
          echo "    pre-commit run --all-files"

  tests:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          # Only test oldest supported and latest python version to reduce
          # GitHub API calls, as they can get rate limited
          - python-version: "3.10"
          - python-version: 3.x

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "${{ matrix.python-version }}"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[testing]
      # This sets a private access token for @choldgraf that has public read-only access.
      # It only applies to a non-fork repository. If the repository for the PR is a fork,
      # then it won't run and we'll use the default repository rate limit.
      #   FUTURE: We should update the tests to only pull from this repository and not
      #   need a token at all.
      - name: Set variable if we're in a non-fork PR
        if: github.event.pull_request.head.repo.full_name == github.repository
        run: echo "GITHUB_ACCESS_TOKEN=${{ secrets.TOKEN_READONLY }}" >> $GITHUB_ENV
      - name: Run tests
        run: pytest --verbose --color=yes --durations=10

  docs:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.13
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[sphinx]

      - name: Build docs
        run: |
          cd docs
          make dirhtml
